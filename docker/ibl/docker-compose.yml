# Setup containers for IBL datajoint pipeline ingestion routines
# Joseph Burling <joseph@datajoint.com>
# --------------------------------------------------------------------------------------
# Basic usage:
#   docker-compose build conda alyx ingest
#   docker-compose up --detach pgserv alyx ingest
#
# Compose Script Example Usage:
#   ./compose --help
#   ./compose build up
#   ./compose --env=./admin/ingest.env build up
#   ./compose --force up
#   ./compose up

# Shared properties across services ----------------------------------------------------
x-user-build-args: &user-build-args
  GROUPNAME: ibl
  USERNAME: ${USER:-ibl}
  USER_GID: ${GID:-1000}
  USER_UID: ${UID:-1000}

x-common-platform: &common-platform
  platform: linux/${LNX_ARCH:-x86_64}

x-ibl-data-volume: &ibl-data-volume
  - type: volume
    source: datacache
    target: ${IBL_PATH_ROOT:?set IBL_PATH_ROOT path in .env file}/data

x-ibl-shared-mount: &ibl-shared-mount
  - type: bind
    source: ../../shared
    target: ${IBL_PATH_ROOT:?set IBL_PATH_ROOT path in .env file}/shared

x-shared-networks: &shared-networks
  networks:
    ibl-dev:

<<: *shared-networks

volumes:
  datacache:
  pgdata:

services:
  # Base Conda Environment -------------------------------------------------------------
  conda:
    image: ibl_conda_base
    <<: *common-platform
    init: true
    build:
      context: ../conda_base_debian
      args:
        <<: *user-build-args

  # Postgres Server --------------------------------------------------------------------
  pgserv:
    image: postgres:13.3
    <<: *common-platform
    <<: *shared-networks
    user: postgres
    environment:
      - POSTGRES_USER=${ALYX_DB_USER:?set ALYX_DB_USER in .env file}
      - POSTGRES_PASSWORD=${ALYX_DB_PASSWORD:?set ALYX_DB_PASSWORD in .env file}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready"]
      interval: 30s
      timeout: 20s
      start_period: 5s
      retries: 6
    volumes:
      - pgdata:/var/lib/postgresql/data

  # Alyx Database ----------------------------------------------------------------------
  alyx:
    <<: *common-platform
    <<: *shared-networks
    volumes:
      - <<: *ibl-data-volume
      - <<: *ibl-shared-mount
    init: true
    depends_on:
      pgserv:
        condition: service_healthy
    build:
      context: ../..
      dockerfile: docker/ibl/alyx/Dockerfile
      args:
        <<: *user-build-args
    environment:
      - IBL_PATH_ROOT=${IBL_PATH_ROOT:?set IBL_PATH_ROOT path in .env file}
      - PGUSER=${ALYX_DB_USER:?set ALYX_DB_USER in .env file}
      - PGPASSWORD=${ALYX_DB_PASSWORD:?set ALYX_DB_PASSWORD in .env file}
      - PGDBNAME=${ALYX_DB_NAME:-iblalyx}
      - PGHOST=${ALYX_DB_HOST:-pgserv}
      - HTTP_DATA_SERVER_LOGIN=${HTTP_DATA_SERVER_LOGIN:-}
      - HTTP_DATA_SERVER_PWD=${HTTP_DATA_SERVER_PWD:-}
      - ALYX_PORT=${ALYX_PORT:-8888}
    ports:
      - "${ALYX_PORT:-8888}:${ALYX_PORT:-8888}"

  # IBL Environment for DataJoint Ingestion --------------------------------------------
  ingest:
    <<: *common-platform
    <<: *shared-networks
    volumes:
      - <<: *ibl-data-volume
      - <<: *ibl-shared-mount
      - type: bind
        source: ../../ibl_pipeline
        target: ${IBL_PATH_ROOT:?set IBL_PATH_ROOT path in .env file}/ibldatajoint/ibl_pipeline
    init: true
    depends_on:
      alyx:
        condition: service_started
    build:
      context: ../..
      dockerfile: docker/ibl/ingest/Dockerfile
      args:
        <<: *user-build-args
        CONDA_ENV_FILE: ${CONDA_ENV_FILE:-__NULL}
        APT_REQUIREMENTS: ${APT_REQUIREMENTS:-docker/ibl/ingest/apt_requirements.txt}
        DOT_ONE_FILE: ${DOT_ONE_FILE:-docker/ibl/template.one_params}
    environment:
      - IBL_PATH_ROOT=${IBL_PATH_ROOT:?set IBL_PATH_ROOT path in .env file}
    expose:
      - "${ALYX_PORT:-8888}"
