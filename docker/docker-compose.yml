# Setup containers for IBL datajoint pipeline ingestion routines
# Joseph Burling <joseph@datajoint.com>
# --------------------------------------------------------------------------------------
# Basic usage:
#   docker-compose up --detach
#   docker-compose down
#   docker-compose up --detach jupyter
#   docker-compose down --volumes
#

version: "2.4"

# Shared properties across services ----------------------------------------------------
x-image-iblenv: &image-iblenv
  image: ghcr.io/${GITHUB_USERNAME:-iamamutt}/iblenv_alyx:latest

# postgres/flatiron/django related environment variables
x-env-vars-django-alyx: &env-vars-django-alyx
  DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY:-supersecretiblalyxkey}
  FLATIRON_SERVER_LOGIN: ${HTTP_DATA_SERVER_LOGIN:?set HTTP_DATA_SERVER_LOGIN in .env file}
  FLATIRON_SERVER_PWD: ${HTTP_DATA_SERVER_PWD:?set HTTP_DATA_SERVER_PWD in .env file}
  FLATIRON_SERVER: ${HTTP_DATA_SERVER:-https://ibl.flatironinstitute.org}
  PGDATABASE: ${POSTGRES_DB:-alyxdb}
  PGHOST: ${PGHOST:-pgserver}
  PGPASSWORD: ${POSTGRES_PASSWORD:?set POSTGRES_PASSWORD in .env file}
  PGUSER: ${POSTGRES_USER:-alyxadmin}

# ONE alyx/flatiron access and credentials
x-env-vars-one-alyx: &env-vars-one-alyx
  ALYX_LOGIN: ${ALYX_LOGIN:-}
  ALYX_PORT: ${ALYX_PORT:-8000}
  ALYX_PWD: ${ALYX_PWD:-}
  ALYX_URL: ${ALYX_URL:-}
  HTTP_DATA_SERVER_LOGIN: ${HTTP_DATA_SERVER_LOGIN:?set HTTP_DATA_SERVER_LOGIN in .env file}
  HTTP_DATA_SERVER_PWD: ${HTTP_DATA_SERVER_PWD:?set HTTP_DATA_SERVER_PWD in .env file}
  HTTP_DATA_SERVER: ${HTTP_DATA_SERVER:-https://ibl.flatironinstitute.org}

# datajoint variables and external store access
x-env-vars-dj: &env-vars-dj
  DJ_HOST: ${DJ_HOST:-datajoint.internationalbrainlab.org}
  DJ_MODE: ${DJ_MODE:-test}
  DJ_PASS: ${DJ_PASS:-simple}
  DJ_USER: ${DJ_USER:-root}
  S3_ACCESS: ${S3_ACCESS:-}
  S3_MIGRATE_BUCKET: ${S3_MIGRATE_BUCKET:-ibl-dj-external-public}
  S3_ROOT_PATH: ${S3_ROOT_PATH:-}
  S3_SECRET: ${S3_SECRET:-}

x-volume-mount-data-cache:
  - &volume-mount-data-cache data_cache:/int-brain-lab/data

x-volume-bind-shared:
  - &volume-bind-shared ${LOCAL_SHARED:-../shared}:/int-brain-lab/shared

x-volume-bind-ibl-pipeline:
  - &volume-bind-ibl-pipeline ${LOCAL_PIPELINE:-../ibl_pipeline}:/int-brain-lab/IBL-pipeline/ibl_pipeline

x-volume-mount-vscode-server:
  - &volume-mount-vscode-server vscode-server:/home/ibl/.vscode-server/extensions

x-service-ibl-common: &service-ibl-common
  <<: *image-iblenv
  environment:
    <<: *env-vars-django-alyx
  volumes:
    - *volume-bind-shared
    - *volume-mount-data-cache
  networks:
    iblenv:
  entrypoint: ["bash", "-lc"]
  command: "tail -f /dev/null"
  init: true
  tty: true

x-service-ibl-pipeline: &service-ibl-pipeline
  <<: *service-ibl-common
  environment:
    <<: *env-vars-django-alyx
    <<: *env-vars-one-alyx
    <<: *env-vars-dj
  entrypoint:
    - ingest
  depends_on:
    alyx:
      condition: service_healthy

# Global Networks and Volumes ----------------------------------------------------------
networks:
  iblenv:
    name: iblenv_alyx_network

volumes:
  data_cache:
    name: iblenv_alyx_data_cache
  pgdata:
    name: iblenv_alyx_pgdata
  vscode-server:
    name: dev-vscode-server

services:
  # Postgres Server --------------------------------------------------------------------
  pgserver:
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-alyxdb}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?set POSTGRES_PASSWORD in .env file}
      POSTGRES_USER: ${POSTGRES_USER:-alyxadmin}
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready
      timeout: 15s
      interval: 30s
      retries: 5
      start_period: 10s
    image: postgres:13-bullseye
    networks:
      iblenv:
    ports:
      - "5438:5432"
    volumes:
      - type: volume
        source: pgdata
        target: /var/lib/postgresql/data
        volume: {}

  # IBL Environment for DataJoint Ingestion --------------------------------------------
  alyx:
    <<: *service-ibl-common
    entrypoint:
      - alyx_entrypoint
    command: ""
    depends_on:
      pgserver:
        condition: service_healthy
    healthcheck:
      test:
        - CMD
        - alyx
        - checkserver
      timeout: 15s
      interval: 30s
      retries: 5
      start_period: 2m0s
    ports:
      - ${ALYX_PORT:-8000}:${ALYX_PORT:-8000}

  ingest:
    <<: *service-ibl-pipeline
    command:
      - config_init
      - --alyxhost=private
      - populate
      - ingest
      - --duration=-1
      - --sleep=5
      - --backtrack=5
    scale: ${WORKER_COUNT:-1}

  populate_behavior:
    <<: *service-ibl-pipeline
    command:
      - config_init
      - --alyxhost=private
      - populate
      - behavior
      - --duration=-1
      - --sleep=5
      - --backtrack=10

  iblenv:
    <<: *service-ibl-pipeline
    volumes:
      - *volume-mount-data-cache
      - *volume-bind-shared
      - *volume-bind-ibl-pipeline
      - *volume-mount-vscode-server
    ports:
      - ${JUPYTER_PORT:-10000}:${JUPYTER_PORT:-10000}
    command:
      - config_init
      - --alyxhost=dev
      - jupyterlab
    working_dir: /int-brain-lab/IBL-pipeline
